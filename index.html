<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ìš°ì£¼ ë¹„í–‰ê¸° ê²Œì„</title>
    <style>
        /* ì „ì²´ í˜ì´ì§€ ìŠ¤íƒ€ì¼ë§ */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            position: relative;
            font-family: Arial, sans-serif;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        /* ê²Œì„ ì»¨í…Œì´ë„ˆ: ì „ì²´ í™”ë©´ì— ê²Œì„ ìº”ë²„ìŠ¤ ë°°ì¹˜ */
        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* ê²Œì„ ìº”ë²„ìŠ¤: ì „ì²´ í™”ë©´ ê½‰ ì±„ìš°ê¸° */
        #gameCanvas {
            max-width: 100%;
            max-height: 100%;
            aspect-ratio: 9/16;  /* ëª¨ë°”ì¼ ì„¸ë¡œ ë¹„ìœ¨ */
            width: auto;
            height: auto;
            touch-action: none;  /* í„°ì¹˜ ì´ë²¤íŠ¸ ìµœì í™” */
            box-shadow: 0 0 20px rgba(0, 100, 255, 0.5);  /* ìº”ë²„ìŠ¤ ì£¼ìœ„ì— íŒŒë€ìƒ‰ ê¸€ë¡œìš° íš¨ê³¼ */
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        /* í™”ë©´ ë°©í–¥ì— ë”°ë¥¸ ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì • */
        @media (orientation: portrait) {
            #gameCanvas {
                width: 100%;
                height: auto;
            }
        }

        @media (orientation: landscape) {
            #gameCanvas {
                height: 100vh;
                width: auto;
            }
        }

        /* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
        .control-buttons {
            position: fixed;
            bottom: 5vh;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center; /* ì¤‘ì•™ ì •ë ¬ë¡œ ë³€ê²½ */
            padding: 0 10vw;
            pointer-events: none;
            z-index: 10;
        }

        /* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .control-button {
            width: 15vw;
            height: 15vw;
            max-width: 80px;
            max-height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: white;
            pointer-events: auto;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            cursor: pointer;
            outline: none;
            transition: all 0.2s ease;
        }

        /* ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ (ë°ìŠ¤í¬í†±) */
        .control-button:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }

        /* ë²„íŠ¼ í™œì„±í™” íš¨ê³¼ */
        .control-button:active {
            background: rgba(255, 255, 255, 0.7);
            transform: scale(0.95);
        }

        /* ë²„íŠ¼ ë‚´ í™”ì‚´í‘œ ì•„ì´ì½˜ */
        .control-button::before {
            content: attr(data-arrow);
            pointer-events: none;
        }

        /* ì¬ì‹œì‘ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #restartBtn {
            display: none;
            position: absolute;
            left: 50%;
            top: 60%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
            font-size: 32px;
            background: rgba(255, 255, 255, 0.4);
            border: 3px solid white;
            color: white;
            border-radius: 50%;
            z-index: 100;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            animation: pulse 1.5s infinite;
        }

        /* ì¬ì‹œì‘ ë²„íŠ¼ í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7);
            }
            70% {
                transform: translate(-50%, -50%) scale(1.05);
                box-shadow: 0 0 0 10px rgba(255, 255, 255, 0);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
            }
        }

        /* ê²Œì„ ë¡œë“œ í™”ë©´ */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        #loadingScreen h1 {
            color: white;
            margin-bottom: 20px;
            font-size: 36px;
            text-align: center;
            text-shadow: 0 0 10px #00f, 0 0 20px #00f, 0 0 30px #00f;
            animation: glow 1.5s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from {
                text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #00f, 0 0 20px #00f;
            }
            to {
                text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #00f, 0 0 40px #00f;
            }
        }

        #loadingBar {
            width: 80%;
            max-width: 400px;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 0, 255, 0.5);
        }

        #loadingProgress {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #ffff00);
            transition: width 0.3s;
        }

        /* ì¸íŠ¸ë¡œ ë¹„ë””ì˜¤ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        #introContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            overflow: hidden;
            opacity: 1;
            transition: opacity 0.8s ease;
        }

        /* ì¸íŠ¸ë¡œ ë¹„ë””ì˜¤ ìŠ¤íƒ€ì¼ */
        #introVideo {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        /* ì¸íŠ¸ë¡œ ìŠ¤í‚µ ë²„íŠ¼ */
        #skipIntro {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid white;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            z-index: 2001;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        #skipIntro:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        #skipIntro:active {
            background: rgba(255, 255, 255, 0.7);
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <!-- ì¸íŠ¸ë¡œ ë¹„ë””ì˜¤ -->
    <div id="introContainer">
        <video id="introVideo" playsinline muted>
            <source src="intro.mp4" type="video/mp4">
            ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </video>
        <button id="skipIntro">SKIP</button>
    </div>

    <div class="game-container">
        <canvas id="gameCanvas"></canvas>
        <div class="control-buttons">
            <!-- ì¬ì‹œì‘ ë²„íŠ¼ë§Œ ë‚¨ê¸°ê¸° -->
            <button id="restartBtn" class="control-button" data-arrow="â†º"></button>
        </div>
    </div>
    
    <script>
        // --- ì¸íŠ¸ë¡œ ë¹„ë””ì˜¤ ì²˜ë¦¬ ---
        const introContainer = document.getElementById("introContainer");
        const introVideo = document.getElementById("introVideo");
        const skipIntroBtn = document.getElementById("skipIntro");
        const loadingScreen = document.getElementById("loadingScreen");

        // ì´ˆê¸°ì— ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
        if (loadingScreen) {
          loadingScreen.style.display = "none";
        }

        // ì¸íŠ¸ë¡œ ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘
        let introPlayed = false;
        function playIntro() {
          // ìë™ ì¬ìƒ ì‹œë„ - ì¬ìƒ ë²„íŠ¼ ì—†ì´ ë°”ë¡œ ì‹œì‘
          introVideo.play().catch(error => {
            console.error("ë¹„ë””ì˜¤ ìë™ ì¬ìƒ ì‹¤íŒ¨:", error);
            // ìë™ ì¬ìƒ ì •ì±…ìœ¼ë¡œ ì¸í•´ ì‹¤íŒ¨í•œ ê²½ìš°ì—ë„ ê²Œì„ìœ¼ë¡œ ë°”ë¡œ ë„˜ì–´ê°€ë„ë¡ í•¨
            setTimeout(finishIntro, 500);
          });
        }

        // ì¸íŠ¸ë¡œ ì™„ë£Œ ì‹œ ê²Œì„ìœ¼ë¡œ í˜ì´ë“œ ì „í™˜
        function finishIntro() {
          if (introPlayed) return; // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
          introPlayed = true;
          
          // ì¸íŠ¸ë¡œ ë¹„ë””ì˜¤ í˜ì´ë“œ ì•„ì›ƒ
          let opacity = 1;
          const fadeOutInterval = setInterval(() => {
            opacity -= 0.05;
            introContainer.style.opacity = opacity;
            
            if (opacity <= 0) {
              clearInterval(fadeOutInterval);
              introContainer.style.display = "none";
              
              // ì´ë¯¸ì§€ ë¡œë”© í™”ë©´ í‘œì‹œ ë° í˜ì´ë“œ ì¸
              if (loadingScreen) {
                loadingScreen.style.opacity = 0;
                loadingScreen.style.display = "flex";
                
                let loadingOpacity = 0;
                const fadeInInterval = setInterval(() => {
                  loadingOpacity += 0.05;
                  loadingScreen.style.opacity = loadingOpacity;
                  
                  if (loadingOpacity >= 1) {
                    clearInterval(fadeInInterval);
                    // ì›ë˜ ê²Œì„ ë¡œë”© ë¡œì§ ê³„ì† ì§„í–‰
                    checkImagesLoaded();
                  }
                }, 30);
              } else {
                // ë¡œë”© í™”ë©´ì´ ì—†ëŠ” ê²½ìš° ë°”ë¡œ ê²Œì„ ë¡œë”©
                checkImagesLoaded();
              }
            }
          }, 30);
        }

        // ìŠ¤í‚µ ë²„íŠ¼ ì´ë²¤íŠ¸
        skipIntroBtn.addEventListener("click", finishIntro);

        // ë¹„ë””ì˜¤ ì¢…ë£Œ ì´ë²¤íŠ¸
        introVideo.addEventListener("ended", finishIntro);

        // --- 1) ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ ---
        const ASSETS = {
          bg:  "background.png",
          p:   "player.png",
          e1:  "enemy1.png",
          e2:  "enemy2.png",
          h1:  "health_item1.png",
          h2:  "health_item2.png"
        };
        const IMG = {};
        let loadedCount = 0;
        const TOTAL_ASSETS = Object.keys(ASSETS).length;

        // ì´ë¯¸ì§€ ë¡œë”© ìƒíƒœ í™•ì¸ í•¨ìˆ˜
        function checkImagesLoaded() {
          for (const key in ASSETS) {
            IMG[key] = new Image();
            IMG[key].src = ASSETS[key];
            IMG[key].onload = () => {
              if (++loadedCount === TOTAL_ASSETS) initGame();
            };
            IMG[key].onerror = () => {
              console.log("ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: ", ASSETS[key]);
              // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨í•´ë„ ê²Œì„ ì‹œì‘í•˜ë„ë¡ ì²˜ë¦¬
              if (++loadedCount === TOTAL_ASSETS) initGame();
            };
          }
          
          // ëª¨ë“  ì´ë¯¸ì§€ê°€ ì•„ì§, ë¡œë“œë˜ì§€ ì•Šì•˜ë‹¤ë©´ 5ì´ˆ í›„ ê°•ì œ ì‹œì‘
          setTimeout(function() {
            if (!gameOver && !player) {
              console.log("ê°•ì œ ê²Œì„ ì‹œì‘");
              initGame();
            }
          }, 5000);
        }

        // --- 2) ìº”ë²„ìŠ¤ ì„¤ì • ---
        const canvas = document.getElementById("gameCanvas");
        const ctx    = canvas.getContext("2d");
        canvas.width  = 800;
        canvas.height = 600;

        // --- 3) ìƒìˆ˜ ì •ì˜ ---
        const PLAYER_SIZE   = 130;
        const ENEMY_SIZE    = 110;    // ì  í¬ê¸°
        const ITEM_SIZE     = 110;
        const ITEM_INTERVAL = 10000; // 10ì´ˆë§ˆë‹¤ ì•„ì´í…œ
        const BASE_SHOT_INT = 500;   // ìë™ ë°œì‚¬ ê¸°ë³¸ ê°„ê²©(ms)
        const SPEED_FACTOR  = 0.02;  // ì  ì†ë„ ì¦ê°€ ë¹„ìœ¨ (ì´ˆë‹¹)

        // --- 4) ìƒíƒœ ë³€ìˆ˜ ---
        let player, enemies, missiles, items;
        let playerEnergy, score, gameOver;
        let missileCount, missilePickups, shotInterval;
        let lastItemTime, lastShotTime, startTime;

        // í„°ì¹˜/ë§ˆìš°ìŠ¤ ìœ„ì¹˜ ë³€ìˆ˜
        let touchX = null;
        let touchY = null;
        let isTouching = false;

        // --- 5) í‚¤ ì…ë ¥ & ë²„íŠ¼ ì´ë²¤íŠ¸ ---
        const keys = {};
        window.addEventListener("keydown", e => keys[e.key] = true);
        window.addEventListener("keyup",   e => keys[e.key] = false);

        // ì¬ì‹œì‘ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const restartBtn = document.getElementById("restartBtn");
        if (restartBtn) {
          restartBtn.addEventListener("click", function() {
            this.style.display = "none";
            initGame();
          });
        }

        // í„°ì¹˜/ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        canvas.addEventListener("touchstart", handleTouchStart, { passive: false });
        canvas.addEventListener("touchmove", handleTouchMove, { passive: false });
        canvas.addEventListener("touchend", handleTouchEnd);
        canvas.addEventListener("mousedown", handleMouseDown);
        canvas.addEventListener("mousemove", handleMouseMove);
        canvas.addEventListener("mouseup", handleMouseUp);

        function handleTouchStart(e) {
          e.preventDefault();
          isTouching = true;
          const touch = e.touches[0];
          const rect = canvas.getBoundingClientRect();
          touchX = touch.clientX - rect.left;
          touchY = touch.clientY - rect.top;
        }

        function handleTouchMove(e) {
          if (!isTouching) return;
          e.preventDefault();
          const touch = e.touches[0];
          const rect = canvas.getBoundingClientRect();
          touchX = touch.clientX - rect.left;
          touchY = touch.clientY - rect.top;
        }

        function handleTouchEnd() {
          isTouching = false;
        }

        function handleMouseDown(e) {
          isTouching = true;
          const rect = canvas.getBoundingClientRect();
          touchX = e.clientX - rect.left;
          touchY = e.clientY - rect.top;
        }

        function handleMouseMove(e) {
          if (!isTouching) return;
          const rect = canvas.getBoundingClientRect();
          touchX = e.clientX - rect.left;
          touchY = e.clientY - rect.top;
        }

        function handleMouseUp() {
          isTouching = false;
        }

        window.addEventListener("keydown", e => {
          if (e.key === " ") shootMissile();
        });

        // --- 6) í´ë˜ìŠ¤ ì •ì˜ ---
        class Player {
          constructor() {
            this.w  = PLAYER_SIZE;
            this.h  = PLAYER_SIZE;
            this.x  = canvas.width/2 - this.w/2;
            this.y  = canvas.height - this.h - 10;
            this.sp = 5;
          }
          move() {
            // í„°ì¹˜/ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ë¡œ ì´ë™ (ëª¨ë°”ì¼)
            if (isTouching && touchX !== null && touchY !== null) {
              const targetX = touchX - this.w / 2;
              const targetY = touchY - this.h / 2;
              
              // ë¶€ë“œëŸ¬ìš´ ì´ë™ì„ ìœ„í•œ ë³´ê°„
              this.x += (targetX - this.x) * 0.1;
              this.y += (targetY - this.y) * 0.1;
              
              // ê²½ê³„ í™•ì¸
              this.x = Math.max(0, Math.min(canvas.width - this.w, this.x));
              this.y = Math.max(0, Math.min(canvas.height - this.h, this.y));
            }
            
            // í‚¤ë³´ë“œë¡œ ì´ë™ (ì›¹)
            if (keys["ArrowLeft"] && this.x > 0)
              this.x -= this.sp;
            if (keys["ArrowRight"] && this.x < canvas.width - this.w)
              this.x += this.sp;
            if (keys["ArrowUp"] && this.y > 0)
              this.y -= this.sp;
            if (keys["ArrowDown"] && this.y < canvas.height - this.h)
              this.y += this.sp;
          }
          draw() {
            // ì´ë¯¸ì§€ê°€ ë¡œë“œ ì•ˆëìœ¼ë©´ ê¸°ë³¸ ì‚¬ê°í˜•ìœ¼ë¡œ í‘œì‹œ
            if (IMG.p && IMG.p.complete) {
              ctx.drawImage(IMG.p, this.x, this.y, this.w, this.h);
            } else {
              ctx.fillStyle = "blue";
              ctx.fillRect(this.x, this.y, this.w, this.h);
            }
          }
        }

        class Missile {
          constructor(x, y, ang = 0) {
            this.x = x;
            this.y = y;
            this.w = 8;
            this.h = 16;
            this.sp  = 8;
            this.ang = ang * Math.PI/180;
          }
          move() {
            this.y -= this.sp;
            this.x += Math.sin(this.ang) * 5;
          }
          draw() {
            ctx.fillStyle = "red";
            ctx.fillRect(this.x, this.y, this.w, this.h);
          }
        }

        class Enemy {
          constructor(type) {
            this.w      = ENEMY_SIZE;
            this.h      = ENEMY_SIZE;
            this.x      = Math.random() * (canvas.width - this.w);
            this.y      = -this.h;
            this.type   = type;       // 1 ë˜ëŠ” 2
            this.health = type;       // ì²´ë ¥: 1 or 2
            this.baseSp = 1;          // ê¸°ë³¸ ì†ë„
          }
          move(now) {
            const elapsed = (now - startTime) / 1000;
            const speed   = this.baseSp + elapsed * SPEED_FACTOR;
            this.y += speed;
          }
          draw() {
            // ì´ë¯¸ì§€ê°€ ë¡œë“œ ì•ˆëìœ¼ë©´ ê¸°ë³¸ ì‚¬ê°í˜•ìœ¼ë¡œ í‘œì‹œ
            const img = this.type === 1 ? IMG.e1 : IMG.e2;
            if (img && img.complete) {
              ctx.drawImage(img, this.x, this.y, this.w, this.h);
            } else {
              ctx.fillStyle = this.type === 1 ? "purple" : "darkred";
              ctx.fillRect(this.x, this.y, this.w, this.h);
            }
          }
        }

        class Item {
          constructor() {
            this.w    = ITEM_SIZE;
            this.h    = ITEM_SIZE;
            this.x    = Math.random() * (canvas.width - this.w);
            this.y    = -this.h;
            this.sp   = 3;
            this.type = Math.random() < 0.5 ? "health" : "missile";
          }
          move() {
            this.y += this.sp;
          }
          draw() {
            // ì´ë¯¸ì§€ê°€ ë¡œë“œ ì•ˆëìœ¼ë©´ ê¸°ë³¸ ì‚¬ê°í˜•ìœ¼ë¡œ í‘œì‹œ
            const img = this.type === "health" ? IMG.h1 : IMG.h2;
            if (img && img.complete) {
              ctx.drawImage(img, this.x, this.y, this.w, this.h);
            } else {
              ctx.fillStyle = this.type === "health" ? "green" : "orange";
              ctx.fillRect(this.x, this.y, this.w, this.h);
            }
          }
        }

        // --- 7) ì¶©ëŒ ê²€ì‚¬ & ë°œì‚¬ í•¨ìˆ˜ ---
        function isCollision(a, b) {
          return a.x < b.x + b.w &&
                 a.x + a.w > b.x &&
                 a.y < b.y + b.h &&
                 a.y + a.h > b.y;
        }
        function shootMissile() {
          const sx = player.x + player.w/2 - 4;
          const sy = player.y;
          if (missileCount === 1) {
            missiles.push(new Missile(sx, sy));
          } else {
            for (let i = 0; i < missileCount; i++) {
              const ang = (i - (missileCount-1)/2) * 15;
              missiles.push(new Missile(sx, sy, ang));
            }
          }
        }

        // --- 8) ê²Œì„ ì´ˆê¸°í™” ---
        function initGame() {
          player         = new Player();
          enemies        = [];
          missiles       = [];
          items          = [];
          playerEnergy   = 100;
          score          = 0;
          gameOver       = false;
          missileCount   = 1;
          missilePickups = 0;
          shotInterval   = BASE_SHOT_INT;
          startTime      = performance.now();
          lastItemTime   = startTime;
          lastShotTime   = startTime;
          
          // ê²Œì„ ìº”ë²„ìŠ¤ í˜ì´ë“œ ì¸ íš¨ê³¼
          canvas.style.opacity = 0;
          
          // ë¡œë”© í™”ë©´ í˜ì´ë“œ ì•„ì›ƒ í›„ ê²Œì„ í™”ë©´ í˜ì´ë“œ ì¸
          if (loadingScreen) {
            let loadingOpacity = 1;
            const fadeOutInterval = setInterval(() => {
              loadingOpacity -= 0.05;
              loadingScreen.style.opacity = loadingOpacity;
              
              if (loadingOpacity <= 0) {
                clearInterval(fadeOutInterval);
                loadingScreen.style.display = "none";
                
                // ê²Œì„ ìº”ë²„ìŠ¤ í˜ì´ë“œ ì¸
                let canvasOpacity = 0;
                const fadeInInterval = setInterval(() => {
                  canvasOpacity += 0.05;
                  canvas.style.opacity = canvasOpacity;
                  
                  if (canvasOpacity >= 1) {
                    clearInterval(fadeInInterval);
                  }
                }, 30);
                
                // ê²Œì„ ì‹œì‘
                requestAnimationFrame(gameLoop);
              }
            }, 30);
          } else {
            // ë¡œë”© í™”ë©´ì´ ì—†ëŠ” ê²½ìš° ë°”ë¡œ ê²Œì„ ìº”ë²„ìŠ¤ í˜ì´ë“œ ì¸
            let canvasOpacity = 0;
            const fadeInInterval = setInterval(() => {
              canvasOpacity += 0.05;
              canvas.style.opacity = canvasOpacity;
              
              if (canvasOpacity >= 1) {
                clearInterval(fadeInInterval);
              }
            }, 30);
            
            // ì¬ì‹œì‘ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            if (restartBtn) {
              restartBtn.style.display = "none";
            }
            
            // ê²Œì„ ì‹œì‘
            requestAnimationFrame(gameLoop);
          }
        }

        // --- 9) í™”ë©´ ê·¸ë¦¬ê¸° í—¬í¼ ---
        function drawBackground() {
          // ë°°ê²½ ì´ë¯¸ì§€ê°€ ë¡œë“œ ì•ˆëìœ¼ë©´ ê¸°ë³¸ ì‚¬ê°í˜•ìœ¼ë¡œ í‘œì‹œ
          if (IMG.bg && IMG.bg.complete) {
            ctx.drawImage(IMG.bg, 0, 0, canvas.width, canvas.height);
          } else {
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
          }
        }
        function drawUI() {
          ctx.fillStyle = "gray";
          ctx.fillRect(20, 20, 200, 20);
          ctx.fillStyle = "limegreen";
          ctx.fillRect(20, 20, (playerEnergy/100)*200, 20);
          ctx.strokeStyle = "black";
          ctx.strokeRect(20, 20, 200, 20);
          ctx.font = "20px Arial";
          ctx.fillStyle = "white";
          ctx.textAlign = "right";
          ctx.fillText("ì ìˆ˜: " + score, canvas.width - 20, 40);
        }

        // --- 10) ë©”ì¸ ë£¨í”„ ---
        function gameLoop(now) {
          // 1) ë°°ê²½ & UI
          drawBackground();
          drawUI();

          // 2) ìë™ ë¯¸ì‚¬ì¼ ë°œì‚¬
          if (now - lastShotTime >= shotInterval) {
            shootMissile();
            lastShotTime = now;
          }

          // 3) í”Œë ˆì´ì–´
          player.move();
          player.draw();

          // 4) ì  ìŠ¤í°
          if (Math.random() < 0.02) {
            enemies.push(new Enemy(Math.random() < 0.5 ? 1 : 2));
          }

          // 5) ì•„ì´í…œ 10ì´ˆë§ˆë‹¤ ìŠ¤í°
          if (now - lastItemTime >= ITEM_INTERVAL) {
            items.push(new Item());
            lastItemTime = now;
          }

          // 6) ì  ì²˜ë¦¬
          for (let i = enemies.length-1; i >= 0; i--) {
            const e = enemies[i];
            e.move(now);
            e.draw();
            if (e.y > canvas.height) { enemies.splice(i, 1); continue; }

            if (isCollision(player, e)) {
              playerEnergy -= 20;
              enemies.splice(i, 1);
              if (playerEnergy <= 0) gameOver = true;
              continue;
            }
            for (let j = missiles.length-1; j >= 0; j--) {
              if (isCollision(missiles[j], e)) {
                missiles.splice(j, 1);
                e.health--;
                if (e.health <= 0) {
                  score++;
                  enemies.splice(i, 1);
                }
                break;
              }
            }
          }

          // 7) ì•„ì´í…œ ì²˜ë¦¬
          for (let i = items.length-1; i >= 0; i--) {
            const it = items[i];
            it.move();
            it.draw();
            if (it.y > canvas.height) { items.splice(i, 1); continue; }

            if (isCollision(player, it)) {
              if (it.type === "health") {
                playerEnergy = Math.min(100, playerEnergy + 30);
              } else {
                missilePickups = Math.min(3, missilePickups + 1);
                if (missilePickups === 1) {
                  shotInterval = BASE_SHOT_INT / 2;
                } else if (missilePickups === 2) {
                  missileCount = 2;
                } else if (missilePickups === 3) {
                  missileCount = 3;
                }
              }
              items.splice(i, 1);
            }
          }

          // 8) ë¯¸ì‚¬ì¼ ì²˜ë¦¬
          for (let i = missiles.length-1; i >= 0; i--) {
            missiles[i].move();
            missiles[i].draw();
            if (missiles[i].y < -missiles[i].h) missiles.splice(i, 1);
          }

          // 9) ê²Œì„ ì˜¤ë²„
          if (gameOver) {
            ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = "white";
            ctx.font = "40px Arial";
            ctx.textAlign = "center";
            ctx.fillText("ê²Œì„ ì˜¤ë²„!", canvas.width/2, canvas.height/2 - 40);
            ctx.font = "30px Arial";
            ctx.fillText("ìµœì¢… ì ìˆ˜: " + score, canvas.width/2, canvas.height/2);
            
            // ì¬ì‹œì‘ ë²„íŠ¼ í‘œì‹œ
            if (restartBtn) {
              restartBtn.style.display = "flex";
              restartBtn.style.position = "absolute";
              restartBtn.style.left = "50%";
              restartBtn.style.top = "60%";
              restartBtn.style.transform = "translate(-50%, -50%)";
              restartBtn.style.fontSize = "32px";
              restartBtn.style.width = "120px";
              restartBtn.style.height = "120px";
            }
            
            return; // ë£¨í”„ ì™„ì „ ì¢…ë£Œ
          }

          // 10) ë‹¤ìŒ í”„ë ˆì„
          requestAnimationFrame(gameLoop);
        }

        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
          console.log("í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ");
          
          // ëª¨ë°”ì¼ ë””ë°”ì´ìŠ¤ ê°ì§€ ë° UI íŒíŠ¸ í‘œì‹œ
          if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            // ëª¨ë°”ì¼ ë””ë°”ì´ìŠ¤ì¼ ê²½ìš° ìˆ˜í–‰í•  ì‘ì—…
            const touchHint = document.createElement('div');
            touchHint.id = 'touchHint';
            touchHint.innerHTML = 'ğŸ‘† í™”ë©´ì„ í„°ì¹˜í•˜ê³  ë“œë˜ê·¸í•˜ì—¬ ë¹„í–‰ê¸°ë¥¼ ì´ë™í•˜ì„¸ìš”';
            touchHint.style.position = 'fixed';
            touchHint.style.bottom = '20vh';
            touchHint.style.left = '0';
            touchHint.style.width = '100%';
            touchHint.style.textAlign = 'center';
            touchHint.style.color = 'white';
            touchHint.style.fontSize = '16px';
            touchHint.style.padding = '10px';
            touchHint.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            touchHint.style.zIndex = '100';
            touchHint.style.opacity = '0';
            touchHint.style.transition = 'opacity 1s ease';
            
            document.body.appendChild(touchHint);
            
            // ê²Œì„ ì‹œì‘ í›„ íŒíŠ¸ í‘œì‹œ ë° ìë™ ìˆ¨ê¹€
            setTimeout(() => {
              touchHint.style.opacity = '1';
              setTimeout(() => {
                touchHint.style.opacity = '0';
                setTimeout(() => {
                  touchHint.remove();
                }, 1000);
              }, 5000);
            }, 3000);
          }
          
          // ì¸íŠ¸ë¡œ ì‹œì‘
          playIntro();
        });
    </script>
</body>
</html>